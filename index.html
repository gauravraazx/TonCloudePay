<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TON Pay â€” Real Payments</title>

  <!-- TonConnect UI SDK (official) -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #04070f;
      --panel: #0a1020;
      --panel2: #0f1928;
      --border: #182340;
      --ton: #0098EA;
      --ton2: #00c6ff;
      --accent: #4f46e5;
      --green: #00e676;
      --red: #ff4d6d;
      --text: #dce8f5;
      --muted: #4a6080;
      --muted2: #7a90b0;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      min-height: 100vh;
    }

    /* Background */
    .bg-layer {
      position: fixed; inset: 0; z-index: 0; overflow: hidden;
    }
    .bg-layer::before {
      content: '';
      position: absolute; inset: 0;
      background-image:
        linear-gradient(rgba(0,152,234,0.035) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,152,234,0.035) 1px, transparent 1px);
      background-size: 36px 36px;
    }
    .bg-layer::after {
      content: '';
      position: absolute; inset: 0;
      background:
        radial-gradient(ellipse 70% 55% at 15% 10%, rgba(0,152,234,0.1) 0%, transparent 55%),
        radial-gradient(ellipse 60% 70% at 85% 90%, rgba(79,70,229,0.09) 0%, transparent 55%);
    }

    /* App wrapper */
    .app {
      position: relative; z-index: 1;
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding: 36px 16px 80px;
    }

    /* Header */
    header {
      width: 100%; max-width: 480px;
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 44px;
    }
    .logo {
      display: flex; align-items: center; gap: 10px;
      font-size: 21px; font-weight: 800; letter-spacing: -0.5px;
    }
    .logo-gem {
      width: 34px; height: 34px; border-radius: 10px;
      background: linear-gradient(135deg, #0098EA 0%, #4f46e5 100%);
      display: flex; align-items: center; justify-content: center;
    }
    .logo-gem svg { width: 18px; height: 18px; }
    .logo-text em { color: var(--ton2); font-style: normal; }

    .live-badge {
      display: flex; align-items: center; gap: 6px;
      font-family: 'Space Mono', monospace; font-size: 10px;
      color: var(--green);
      background: rgba(0,230,118,0.08);
      border: 1px solid rgba(0,230,118,0.2);
      padding: 5px 11px; border-radius: 20px;
    }
    .live-dot { width: 5px; height: 5px; background: var(--green); border-radius: 50%; animation: blink 1.5s infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

    /* Card */
    .card {
      width: 100%; max-width: 480px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.55), 0 0 0 1px rgba(0,152,234,0.04);
      overflow: hidden;
    }

    /* Card top bar */
    .card-top {
      display: flex; align-items: center; justify-content: space-between;
      padding: 22px 28px 20px;
      border-bottom: 1px solid var(--border);
    }
    .card-label {
      font-size: 11px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 2px; color: var(--muted);
    }

    /* Steps indicator */
    .steps {
      display: flex; align-items: center; gap: 6px;
    }
    .step {
      width: 24px; height: 4px; border-radius: 2px;
      background: var(--border); transition: background 0.4s;
    }
    .step.active { background: var(--ton); }
    .step.done { background: var(--green); }

    /* Section panes */
    .pane { padding: 28px 28px 32px; }

    /* STEP 1 â€” Connect */
    #step-connect .connect-heading {
      font-size: 20px; font-weight: 800; margin-bottom: 6px;
    }
    #step-connect .connect-sub {
      font-size: 14px; color: var(--muted2); line-height: 1.6; margin-bottom: 28px;
    }

    /* TonConnect UI button will be injected here */
    #ton-connect-btn-wrap {
      display: flex; justify-content: center;
    }
    /* Override TonConnect default button style */
    #ton-connect-btn-wrap tc-root {
      width: 100%;
    }

    /* Fallback manual connect button */
    .manual-connect-btn {
      width: 100%; padding: 17px 20px;
      background: linear-gradient(135deg, rgba(0,152,234,0.18), rgba(79,70,229,0.12));
      border: 1.5px solid rgba(0,152,234,0.35);
      border-radius: 14px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 12px;
      font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700;
      color: var(--ton2); transition: all 0.25s;
    }
    .manual-connect-btn:hover {
      background: linear-gradient(135deg, rgba(0,152,234,0.28), rgba(79,70,229,0.2));
      transform: translateY(-2px); box-shadow: 0 10px 32px rgba(0,152,234,0.22);
    }

    /* STEP 2 â€” Connected info bar */
    .wallet-bar {
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(0,230,118,0.06); border: 1px solid rgba(0,230,118,0.18);
      border-radius: 12px; padding: 12px 16px; margin-bottom: 24px;
    }
    .wallet-bar-left { display: flex; align-items: center; gap: 10px; }
    .wallet-avatar {
      width: 32px; height: 32px; border-radius: 50%;
      background: linear-gradient(135deg, var(--ton), var(--accent));
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
    }
    .wallet-name { font-size: 13px; font-weight: 700; }
    .wallet-addr-short { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted2); }
    .disconnect-btn {
      background: none; border: none; color: var(--muted);
      font-size: 12px; font-family: 'Syne',sans-serif;
      cursor: pointer; padding: 4px 10px; border-radius: 7px; transition: all 0.2s;
    }
    .disconnect-btn:hover { background: rgba(255,77,109,0.1); color: var(--red); }

    /* Form fields */
    .field { margin-bottom: 16px; }
    .field label {
      display: block; font-size: 11px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 1.5px;
      color: var(--muted); margin-bottom: 8px;
    }
    .field input {
      width: 100%; background: rgba(255,255,255,0.025);
      border: 1.5px solid var(--border); border-radius: 12px;
      padding: 13px 15px; color: var(--text);
      font-family: 'Space Mono', monospace; font-size: 13.5px;
      outline: none; transition: all 0.2s;
    }
    .field input::placeholder { color: var(--muted); }
    .field input:focus {
      border-color: var(--ton);
      background: rgba(0,152,234,0.06);
      box-shadow: 0 0 0 3px rgba(0,152,234,0.12);
    }
    .field input.err { border-color: var(--red); }

    .field-hint {
      font-size: 11px; color: var(--muted); margin-top: 5px;
      font-family: 'Space Mono', monospace;
    }
    .field-hint.error-msg { color: var(--red); }

    /* Amount row */
    .amount-row { position: relative; }
    .amount-row input { padding-right: 58px; }
    .ton-unit {
      position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
      font-size: 12px; font-weight: 700; color: var(--ton);
      font-family: 'Syne',sans-serif;
    }

    /* Summary box */
    .summary-box {
      background: rgba(0,152,234,0.05); border: 1px solid rgba(0,152,234,0.12);
      border-radius: 12px; padding: 14px 16px; margin: 18px 0;
    }
    .summary-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 5px 0;
    }
    .summary-row:not(:last-child) { border-bottom: 1px solid rgba(255,255,255,0.04); padding-bottom: 9px; margin-bottom: 4px; }
    .s-key { font-size: 12px; color: var(--muted2); }
    .s-val { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--text); }
    .s-val.highlight { color: var(--ton2); font-weight: 700; }

    /* Pay button */
    .pay-btn {
      width: 100%; padding: 17px;
      background: linear-gradient(90deg, #0098EA, #0070c0);
      border: none; border-radius: 13px;
      font-family: 'Syne',sans-serif; font-size: 16px; font-weight: 800;
      color: #fff; cursor: pointer; transition: all 0.28s;
      position: relative; overflow: hidden; letter-spacing: 0.3px;
    }
    .pay-btn::before {
      content: ''; position: absolute;
      top: 0; left: -100%; width: 60%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
      transition: left 0.6s;
    }
    .pay-btn:hover::before { left: 150%; }
    .pay-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 36px rgba(0,152,234,0.38); }
    .pay-btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; box-shadow: none; }

    /* Spinner */
    .spin {
      display: inline-block; width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.35); border-top-color: #fff;
      border-radius: 50%; animation: rot 0.7s linear infinite;
      vertical-align: middle; margin-right: 8px;
    }
    @keyframes rot { to { transform: rotate(360deg); } }

    /* Status area */
    #status-box {
      margin-top: 14px; border-radius: 11px;
      padding: 12px 16px; font-size: 13px;
      display: none; align-items: flex-start; gap: 10px;
    }
    #status-box.info { display: flex; background: rgba(0,152,234,0.08); border: 1px solid rgba(0,152,234,0.2); color: var(--ton2); }
    #status-box.success { display: flex; background: rgba(0,230,118,0.08); border: 1px solid rgba(0,230,118,0.2); color: var(--green); }
    #status-box.error { display: flex; background: rgba(255,77,109,0.08); border: 1px solid rgba(255,77,109,0.2); color: var(--red); }
    #status-box .s-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
    #status-box .s-text { line-height: 1.5; }
    #status-box .s-text a { color: inherit; word-break: break-all; }

    /* Footer info */
    .footer-note {
      margin-top: 20px; text-align: center;
      font-size: 12px; color: var(--muted);
      font-family: 'Space Mono', monospace; line-height: 1.6;
    }
    .footer-note a { color: var(--ton); text-decoration: none; }

    /* Confetti canvas */
    #confetti { position: fixed; inset: 0; pointer-events: none; z-index: 999; }

    @media (max-width: 500px) {
      .pane { padding: 22px 18px 26px; }
      .card-top { padding: 18px 18px 16px; }
    }
  </style>
</head>
<body>

<div class="bg-layer"></div>
<canvas id="confetti"></canvas>

<div class="app">
  <header>
    <div class="logo">
      <div class="logo-gem">
        <svg viewBox="0 0 56 56" fill="none"><path d="M37.56 15.63H18.44c-3.52 0-5.74 3.75-3.97 6.8l11.8 20.43c.74 1.27 2.73 1.27 3.47 0L41.54 22.43c1.77-3.05-.45-6.8-3.98-6.8z" fill="white"/></svg>
      </div>
      <span class="logo-text">TON<em>Pay</em></span>
    </div>
    <div class="live-badge">
      <div class="live-dot"></div>
      MAINNET LIVE
    </div>
  </header>

  <div class="card">
    <div class="card-top">
      <div class="card-label" id="step-label">Step 1 â€” Connect Wallet</div>
      <div class="steps">
        <div class="step active" id="s1"></div>
        <div class="step" id="s2"></div>
        <div class="step" id="s3"></div>
      </div>
    </div>

    <!-- STEP 1: Connect -->
    <div class="pane" id="step-connect">
      <div class="connect-heading">Connect your TON Wallet</div>
      <div class="connect-sub">Securely connect via TonConnect 2.0. Your keys never leave your wallet.</div>

      <!-- Official TonConnect UI button -->
      <div id="ton-connect-btn-wrap"></div>
    </div>

    <!-- STEP 2: Payment Form (hidden until connected) -->
    <div class="pane" id="step-pay" style="display:none">
      <!-- Connected wallet bar -->
      <div class="wallet-bar">
        <div class="wallet-bar-left">
          <div class="wallet-avatar">ğŸ’</div>
          <div>
            <div class="wallet-name" id="wname">Tonkeeper</div>
            <div class="wallet-addr-short" id="waddr">EQ...xxxx</div>
          </div>
        </div>
        <button class="disconnect-btn" onclick="doDisconnect()">Disconnect</button>
      </div>

      <div class="field">
        <label>Recipient Address</label>
        <input type="text" id="to-addr" placeholder="EQxxxxx... or UQxxxxx..." />
        <div class="field-hint" id="addr-hint">Enter valid TON mainnet address</div>
      </div>

      <div class="field">
        <label>Amount (TON)</label>
        <div class="amount-row">
          <input type="number" id="amount" placeholder="0.00" min="0.01" step="0.01" oninput="updateSummary()" />
          <span class="ton-unit">TON</span>
        </div>
        <div class="field-hint" id="amt-hint">Min: 0.01 TON</div>
      </div>

      <div class="field">
        <label>Memo / Comment <span style="font-weight:400;color:var(--muted)">(optional)</span></label>
        <input type="text" id="memo" placeholder="e.g. Invoice #1234 or payment note" />
      </div>

      <div class="summary-box" id="summary-box" style="display:none">
        <div class="summary-row">
          <span class="s-key">You send</span>
          <span class="s-val highlight" id="sum-amount">â€” TON</span>
        </div>
        <div class="summary-row">
          <span class="s-key">Network fee (est.)</span>
          <span class="s-val">~0.005 TON</span>
        </div>
        <div class="summary-row">
          <span class="s-key">Total deducted</span>
          <span class="s-val" id="sum-total">â€” TON</span>
        </div>
      </div>

      <button class="pay-btn" id="pay-btn" onclick="sendPayment()">
        Confirm &amp; Send via Wallet â†’
      </button>

      <div id="status-box">
        <span class="s-icon" id="s-icon">â„¹ï¸</span>
        <div class="s-text" id="s-text"></div>
      </div>
    </div>
  </div>

  <div class="footer-note">
    Powered by <a href="https://ton.org" target="_blank">TON Blockchain</a> Â· TonConnect 2.0<br>
    Transactions are irreversible Â· Always verify recipient address
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TonConnect 2.0 Real Integration
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const TONCENTER_API = 'https://toncenter.com/api/v2';

// Initialize TonConnect UI
let tonConnectUI = null;
let unsubscribe = null;

async function initTonConnect() {
  try {
    tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://raw.githubusercontent.com/ton-community/tutorials/main/03-client/test/public/tonconnect-manifest.json',
      buttonRootId: 'ton-connect-btn-wrap',
      uiPreferences: {
        theme: 'DARK',
        colorsSet: {
          connectButton: {
            background: 'linear-gradient(90deg, #0098EA, #005EB8)',
            foreground: '#ffffff'
          }
        }
      }
    });

    // Subscribe to wallet status changes
    unsubscribe = tonConnectUI.onStatusChange(walletInfo => {
      if (walletInfo) {
        onWalletConnected(walletInfo);
      } else {
        onWalletDisconnected();
      }
    });

  } catch (err) {
    console.error('TonConnect init error:', err);
    // Fallback: show manual connect button if SDK fails
    document.getElementById('ton-connect-btn-wrap').innerHTML = `
      <button class="manual-connect-btn" onclick="initFallback()">
        <svg width="22" height="22" viewBox="0 0 56 56" fill="none">
          <circle cx="28" cy="28" r="28" fill="#0098EA"/>
          <path d="M37.56 15.63H18.44c-3.52 0-5.74 3.75-3.97 6.8l11.8 20.43c.74 1.27 2.73 1.27 3.47 0L41.54 22.43c1.77-3.05-.45-6.8-3.98-6.8z" fill="white"/>
        </svg>
        Connect TON Wallet (TonConnect)
      </button>
    `;
  }
}

function onWalletConnected(walletInfo) {
  const rawAddr = walletInfo.account.address;
  const walletName = walletInfo.device?.appName || 'TON Wallet';

  // Convert raw address to user-friendly format
  const shortAddr = rawAddr.slice(0, 8) + '...' + rawAddr.slice(-6);
  document.getElementById('wname').textContent = walletName;
  document.getElementById('waddr').textContent = shortAddr;

  // Show step 2
  document.getElementById('step-connect').style.display = 'none';
  const payPane = document.getElementById('step-pay');
  payPane.style.display = 'block';
  payPane.style.opacity = '0';
  payPane.style.transform = 'translateY(12px)';
  requestAnimationFrame(() => {
    payPane.style.transition = 'all 0.4s cubic-bezier(0.16,1,0.3,1)';
    payPane.style.opacity = '1';
    payPane.style.transform = 'translateY(0)';
  });

  // Update step indicator
  document.getElementById('step-label').textContent = 'Step 2 â€” Send Payment';
  document.getElementById('s1').className = 'step done';
  document.getElementById('s2').className = 'step active';
}

function onWalletDisconnected() {
  document.getElementById('step-connect').style.display = 'block';
  document.getElementById('step-pay').style.display = 'none';
  document.getElementById('step-label').textContent = 'Step 1 â€” Connect Wallet';
  document.getElementById('s1').className = 'step active';
  document.getElementById('s2').className = 'step';
  document.getElementById('s3').className = 'step';
  hideStatus();
}

async function doDisconnect() {
  if (tonConnectUI) {
    await tonConnectUI.disconnect();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Address validation
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function isValidTONAddress(addr) {
  // TON address: starts with EQ, UQ, kQ, or 0: followed by base64url
  return /^(EQ|UQ|kQ|0Q)[A-Za-z0-9_\-]{46}$/.test(addr.trim()) ||
         /^0:[0-9a-fA-F]{64}$/.test(addr.trim());
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Summary updater
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function updateSummary() {
  const amt = parseFloat(document.getElementById('amount').value);
  if (amt && amt > 0) {
    document.getElementById('sum-amount').textContent = amt.toFixed(9) + ' TON';
    document.getElementById('sum-total').textContent = (amt + 0.005).toFixed(9) + ' TON';
    document.getElementById('summary-box').style.display = 'block';
  } else {
    document.getElementById('summary-box').style.display = 'none';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REAL Payment via TonConnect
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function sendPayment() {
  const toAddr   = document.getElementById('to-addr').value.trim();
  const amountIn = parseFloat(document.getElementById('amount').value);
  const memo     = document.getElementById('memo').value.trim();

  // Validate
  let valid = true;
  document.getElementById('to-addr').classList.remove('err');
  document.getElementById('amount').classList.remove('err');
  document.getElementById('addr-hint').className = 'field-hint';
  document.getElementById('amt-hint').className = 'field-hint';

  if (!toAddr || !isValidTONAddress(toAddr)) {
    document.getElementById('to-addr').classList.add('err');
    document.getElementById('addr-hint').textContent = 'âš  Invalid TON address format';
    document.getElementById('addr-hint').className = 'field-hint error-msg';
    valid = false;
  }
  if (!amountIn || amountIn < 0.01) {
    document.getElementById('amount').classList.add('err');
    document.getElementById('amt-hint').textContent = 'âš  Minimum 0.01 TON required';
    document.getElementById('amt-hint').className = 'field-hint error-msg';
    valid = false;
  }
  if (!valid) return;

  if (!tonConnectUI || !tonConnectUI.connected) {
    showStatus('error', 'âŒ Wallet not connected. Please reconnect.');
    return;
  }

  const btn = document.getElementById('pay-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span> Waiting for wallet approval...';
  showStatus('info', 'ğŸ“² Open your wallet app and approve the transaction.');

  try {
    // Convert TON to nanotons (1 TON = 1,000,000,000 nanotons)
    const nanotons = BigInt(Math.round(amountIn * 1e9)).toString();

    // Build the transaction payload
    const transaction = {
      validUntil: Math.floor(Date.now() / 1000) + 600, // 10 min expiry
      messages: [
        {
          address: toAddr,
          amount: nanotons,
          // Encode memo as text comment (TL-B: 0x00000000 prefix for text comment)
          payload: memo ? encodeTextComment(memo) : undefined,
        }
      ]
    };

    // Send transaction â€” this opens the wallet app (Tonkeeper, etc.) for approval
    const result = await tonConnectUI.sendTransaction(transaction);

    // result.boc = base64 BOC (Bag of Cells) of the signed transaction
    const txBoc = result.boc;

    btn.disabled = false;
    btn.innerHTML = 'Confirm &amp; Send via Wallet â†’';

    // Mark step 3 done
    document.getElementById('s2').className = 'step done';
    document.getElementById('s3').className = 'step done';
    document.getElementById('step-label').textContent = 'Step 3 â€” Confirmed âœ“';

    // Try to get tx hash from BOC
    const txHash = await extractTxHash(txBoc);

    showStatus('success',
      `âœ… <strong>Transaction sent!</strong><br>` +
      `Amount: <strong>${amountIn} TON</strong>${memo ? ' Â· Memo: ' + escHtml(memo) : ''}<br>` +
      (txHash
        ? `TX: <a href="https://tonscan.org/tx/${txHash}" target="_blank">${txHash.slice(0,16)}...${txHash.slice(-8)} â†—</a>`
        : `BOC broadcast successful. <a href="https://tonscan.org" target="_blank">Check Tonscan â†—</a>`)
    );

    confetti();

    // Clear form
    document.getElementById('to-addr').value = '';
    document.getElementById('amount').value = '';
    document.getElementById('memo').value = '';
    document.getElementById('summary-box').style.display = 'none';

  } catch (err) {
    btn.disabled = false;
    btn.innerHTML = 'Confirm &amp; Send via Wallet â†’';

    console.error('Transaction error:', err);

    if (err.message?.includes('User rejects') || err.message?.includes('cancel') || err.code === 300) {
      showStatus('error', 'ğŸš« Transaction cancelled by user.');
    } else if (err.message?.includes('Wallet not connected')) {
      showStatus('error', 'âŒ Wallet disconnected. Please reconnect.');
    } else {
      showStatus('error', 'âŒ Transaction failed: ' + (err.message || 'Unknown error'));
    }
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Encode text comment as TON payload (BoC cell)
// Simple text comment cell: 32-bit opcode 0x00000000 + UTF-8 text
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function encodeTextComment(text) {
  // Build binary: 4 bytes opcode (0x00000000) + text bytes
  const textBytes = new TextEncoder().encode(text);
  const payload = new Uint8Array(4 + textBytes.length);
  payload.set([0, 0, 0, 0], 0); // opcode for simple text
  payload.set(textBytes, 4);
  return uint8ArrayToBase64(payload);
}

function uint8ArrayToBase64(bytes) {
  let binary = '';
  bytes.forEach(b => binary += String.fromCharCode(b));
  return btoa(binary);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Extract tx hash from BOC (best-effort)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function extractTxHash(boc) {
  try {
    // Use TonCenter API to get the tx hash from the BOC
    const res = await fetch(`${TONCENTER_API}/sendBocReturnHash`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ boc })
    });
    if (res.ok) {
      const data = await res.json();
      return data.result?.hash || null;
    }
  } catch (e) { /* ignore */ }
  return null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Status box
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showStatus(type, html) {
  const box = document.getElementById('status-box');
  const icon = document.getElementById('s-icon');
  const text = document.getElementById('s-text');
  box.className = type;
  icon.textContent = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
  text.innerHTML = html;
  box.style.display = 'flex';
}
function hideStatus() {
  document.getElementById('status-box').style.display = 'none';
  document.getElementById('status-box').className = '';
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Confetti
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function confetti() {
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  canvas.width = innerWidth; canvas.height = innerHeight;
  const colors = ['#0098EA','#00c6ff','#4f46e5','#00e676','#ffffff','#ffd740'];
  const pts = Array.from({length:100}, () => ({
    x: Math.random()*canvas.width, y: Math.random()*-200,
    r: Math.random()*6+2, c: colors[Math.floor(Math.random()*6)],
    vx:(Math.random()-.5)*2.5, vy:Math.random()*4+1.5,
    va:(Math.random()-.5)*0.15, a:0
  }));
  let f = 0;
  (function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    pts.forEach(p=>{
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a);
      ctx.globalAlpha = Math.max(0, 1 - f/100);
      ctx.fillStyle = p.c;
      ctx.beginPath(); ctx.ellipse(0,0,p.r,p.r*.4,0,0,Math.PI*2); ctx.fill();
      ctx.restore();
      p.y+=p.vy; p.x+=p.vx; p.a+=p.va; p.vy+=.06;
    });
    if(++f < 110) requestAnimationFrame(draw);
    else ctx.clearRect(0,0,canvas.width,canvas.height);
  })();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Fallback if SDK doesn't load
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initFallback() {
  alert('TonConnect SDK failed to load.\n\nPlease host this file on HTTPS, or open in a modern browser.\n\nMake sure your internet is connected â€” the SDK loads from unpkg.com');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Boot
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
  // Check if TonConnect loaded
  if (typeof TON_CONNECT_UI !== 'undefined') {
    initTonConnect();
  } else {
    console.warn('TonConnect UI SDK not loaded');
    document.getElementById('ton-connect-btn-wrap').innerHTML = `
      <div style="padding:16px;background:rgba(255,77,109,0.08);border:1px solid rgba(255,77,109,0.2);border-radius:12px;font-size:13px;color:#ff4d6d;line-height:1.6;">
        âš ï¸ <strong>TonConnect SDK failed to load.</strong><br>
        Please make sure you are connected to the internet and hosting this file over <strong>HTTPS</strong> or opening it directly in a browser.<br><br>
        <a href="https://ton.org/wallets" target="_blank" style="color:#0098EA">Get a TON Wallet â†’</a>
      </div>
    `;
  }
});
</script>
</body>
</html>